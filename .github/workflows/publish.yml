name: ğŸš€ Publish to GitHub Packages

# ActivaciÃ³n: Solo cuando se crea un Release
on:
  release:
    types: [published]
  
  # Para testing manual (eliminar en producciÃ³n)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no publish)'
        required: false
        default: false
        type: boolean

# Permisos mÃ­nimos necesarios para GitHub Packages
permissions:
  contents: read
  packages: write
  id-token: write  # Para OIDC (recomendado)

# Variables de entorno globales
env:
  PYTHON_VERSION: "3.11"
  PACKAGE_NAME: "backbone"
  REGISTRY_URL: "https://upload.pypi.pkg.github.com/FreakJazz/"

jobs:
  # Job 1: ValidaciÃ³n y construcciÃ³n
  build-and-validate:
    name: ğŸ—ï¸ Build & Validate Package
    runs-on: ubuntu-latest
    
    outputs:
      package-version: ${{ steps.version.outputs.version }}
      package-name: ${{ steps.version.outputs.name }}
    
    steps:
      # 1. Checkout del cÃ³digo
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Historia completa para tags
      
      # 2. ConfiguraciÃ³n de Python
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # 3. Upgrade pip y instalar herramientas de build
      - name: ğŸ“¦ Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine wheel setuptools
          pip install -e .  # Instalar el paquete en modo desarrollo
      
      # 4. Extraer informaciÃ³n de versiÃ³n desde pyproject.toml
      - name: ğŸ·ï¸ Extract Package Version
        id: version
        run: |
          # Instalar toml parser si no existe
          pip install tomli || pip install toml
          
          # Extraer versiÃ³n y nombre desde pyproject.toml
          python << 'EOF'
          import sys
          try:
              import tomli as toml
          except ImportError:
              import toml
          
          with open('pyproject.toml', 'rb') as f:
              try:
                  data = tomli.load(f)
              except:
                  with open('pyproject.toml', 'r') as fr:
                      data = toml.load(fr)
          
          version = data['project']['version']
          name = data['project']['name']
          
          print(f"Package: {name}")
          print(f"Version: {version}")
          
          # Output para GitHub Actions
          with open('$GITHUB_OUTPUT', 'a') as f:
              f.write(f'version={version}\n')
              f.write(f'name={name}\n')
          EOF
      
      # 5. Validar que la versiÃ³n coincida con el tag del Release
      - name: âœ… Validate Release Version
        if: github.event_name == 'release'
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          PACKAGE_VERSION="${{ steps.version.outputs.version }}"
          
          # Normalizar tag (remover 'v' si existe)
          NORMALIZED_TAG="${RELEASE_TAG#v}"
          
          echo "Release tag: $RELEASE_TAG"
          echo "Normalized tag: $NORMALIZED_TAG"
          echo "Package version: $PACKAGE_VERSION"
          
          if [ "$NORMALIZED_TAG" != "$PACKAGE_VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "Release tag: $NORMALIZED_TAG"
            echo "pyproject.toml version: $PACKAGE_VERSION"
            exit 1
          fi
          
          echo "âœ… Version validation passed"
      
      # 6. Ejecutar tests (si existen)
      - name: ğŸ§ª Run Tests
        run: |
          # Buscar y ejecutar tests si existen
          if [ -f "test_runner.py" ]; then
            echo "Running test_runner.py..."
            python test_runner.py
          elif [ -d "tests" ]; then
            echo "Running pytest..."
            pip install pytest
            pytest tests/ -v
          elif [ -f "example.py" ]; then
            echo "Running example.py as validation..."
            python example.py
          else
            echo "No tests found, skipping..."
          fi
      
      # 7. Construir el paquete
      - name: ğŸ”¨ Build Package
        run: |
          echo "Building package: ${{ steps.version.outputs.name }} v${{ steps.version.outputs.version }}"
          python -m build
          
          # Listar archivos generados
          echo "Generated files:"
          ls -la dist/
      
      # 8. Validar que el paquete se construyÃ³ correctamente
      - name: ğŸ” Validate Built Package
        run: |
          # Verificar que se generaron los archivos esperados
          if [ ! -f "dist/"*.whl ]; then
            echo "âŒ No wheel file found!"
            exit 1
          fi
          
          if [ ! -f "dist/"*.tar.gz ]; then
            echo "âŒ No source distribution found!"
            exit 1
          fi
          
          # Verificar con twine
          twine check dist/*
          
          echo "âœ… Package validation passed"
      
      # 9. Subir artefactos para el siguiente job
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: package-distributions
          path: dist/
          retention-days: 90

  # Job 2: PublicaciÃ³n en GitHub Packages
  publish-to-github:
    name: ğŸ“¦ Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: build-and-validate
    
    # Solo ejecutar si no es dry run
    if: |
      github.event_name == 'release' || 
      (github.event_name == 'workflow_dispatch' && inputs.dry_run != 'true')
    
    environment:
      name: github-packages
      url: https://github.com/FreakJazz/backbone/packages
    
    steps:
      # 1. Descargar artefactos del job anterior
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: package-distributions
          path: dist/
      
      # 2. Setup Python para twine
      - name: ğŸ Setup Python for Publishing
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # 3. Instalar twine
      - name: ğŸ“¦ Install Twine
        run: |
          python -m pip install --upgrade pip
          pip install twine
      
      # 4. Configurar autenticaciÃ³n para GitHub Packages
      - name: ğŸ”‘ Configure GitHub Packages Authentication
        run: |
          # Crear archivo de configuraciÃ³n para twine
          mkdir -p ~/.pypirc
          cat << EOF > ~/.pypirc
          [distutils]
          index-servers = github
          
          [github]
          repository = ${{ env.REGISTRY_URL }}
          username = __token__
          password = ${{ secrets.GITHUB_TOKEN }}
          EOF
          
          chmod 600 ~/.pypirc
      
      # 5. Validar credenciales (dry run)
      - name: ğŸ” Test Authentication
        run: |
          echo "Testing authentication with GitHub Packages..."
          # No intentar subir, solo validar credenciales
          twine check dist/*
      
      # 6. Publicar en GitHub Packages
      - name: ğŸš€ Publish to GitHub Packages
        run: |
          echo "Publishing ${{ needs.build-and-validate.outputs.package-name }} v${{ needs.build-and-validate.outputs.package-version }}"
          echo "Registry: ${{ env.REGISTRY_URL }}"
          
          # Publicar usando twine
          twine upload \
            --repository github \
            --username __token__ \
            --password ${{ secrets.GITHUB_TOKEN }} \
            --verbose \
            dist/*
          
          echo "âœ… Package published successfully!"
      
      # 7. Crear comentario en el Release
      - name: ğŸ’¬ Comment on Release
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const packageName = "${{ needs.build-and-validate.outputs.package-name }}";
            const version = "${{ needs.build-and-validate.outputs.package-version }}";
            const registryUrl = "https://github.com/FreakJazz/backbone/packages";
            
            const comment = `
            ## ğŸ‰ Package Published Successfully!
            
            **Package:** \`${packageName}\`  
            **Version:** \`${version}\`  
            **Registry:** [GitHub Packages](${registryUrl})
            
            ### ğŸ“¦ Installation
            
            \`\`\`bash
            # Configure GitHub Packages access
            pip install --index-url https://pypi.pkg.github.com/FreakJazz/simple/ ${packageName}==${version}
            \`\`\`
            
            ### ğŸ”— Alternative installation
            
            \`\`\`bash
            pip install git+https://github.com/FreakJazz/backbone.git@v${version}
            \`\`\`
            `;
            
            github.rest.repos.createReleaseComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: comment
            });

  # Job 3: NotificaciÃ³n de Ã©xito
  notify-success:
    name: ğŸ‰ Success Notification
    runs-on: ubuntu-latest
    needs: [build-and-validate, publish-to-github]
    if: success()
    
    steps:
      - name: ğŸ‰ Success Summary
        run: |
          echo "## ğŸ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** ${{ needs.build-and-validate.outputs.package-name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build-and-validate.outputs.package-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Package is available in GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "2. Update dependent projects" >> $GITHUB_STEP_SUMMARY
          echo "3. Announce new version" >> $GITHUB_STEP_SUMMARY

  # Job 4: Manejo de fallos
  handle-failure:
    name: ğŸš¨ Handle Failure
    runs-on: ubuntu-latest
    needs: [build-and-validate, publish-to-github]
    if: failure()
    
    steps:
      - name: ğŸš¨ Failure Notification
        run: |
          echo "## âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Common issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Version mismatch between tag and pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "- Package validation failures" >> $GITHUB_STEP_SUMMARY
          echo "- Authentication issues" >> $GITHUB_STEP_SUMMARY
          echo "- Network connectivity problems" >> $GITHUB_STEP_SUMMARY